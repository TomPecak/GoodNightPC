<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Moja Aplikacja</title>

    <link rel="stylesheet" href="styles.css" />
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="qwebchannel.js"></script>

    <script>
        'use strict';
        var wsUri = "ws://localhost:12345";
        window.loggedin = false;

        window.onload = function () {
            var socket = new WebSocket(wsUri);

            socket.onclose = function () {
                console.error("web channel closed");
            };

            socket.onerror = function (error) {
                console.error("web channel error: " + error);
            };


            socket.onopen = function () {
                console.log("WebSocket połączony!");

                // To jest kluczowe! Tworzymy kanał i przekazujemy mu nasz socket.
                window.channel = new QWebChannel(socket, function (channel) {
                    // Pobieramy obiekt 'backend' (tę nazwę zarejestrowałeś w main.cpp)
                    window.cppBackend = channel.objects.backend;

                    //--------------LAP LIST-----------------------------------
                    //------------by jQuery-------
                    window.cppBackend.lapListChanged.connect(function () {
                        $('#laplist').empty();
                        //access the property
                        window.cppBackend.lapList.forEach(function (lap) {
                            $('#laplist').append(lap + '<br>');
                        });
                    });
                    //---------- clean (Vanilla) JS--------
                    // window.cppBackend.lapListChanged.connect(function () {
                    //     // 1. Zamiast $('#laplist') używamy document.getElementById
                    //     const listDiv = document.getElementById('laplist');

                    //     // 2. Zamiast .empty() używamy wyczyszczenia HTML-a
                    //     listDiv.innerHTML = '';

                    //     // 3. Dodajemy okrążenia (zamiast .append)
                    //     window.cppBackend.lapList.forEach(function (lap) {
                    //         listDiv.innerHTML += lap + '<br>';
                    //     });
                    // });
                    //-------------------------------------------------------

                    // Przykładowe podpięcie pod sygnał:
                    window.cppBackend.counterChanged.connect(function () {
                        console.log("Licznik zmieniony! Nowa wartość: " + window.cppBackend.counter);
                        // Aktualizacja HTML:
                        document.querySelector('.counter').innerText = window.cppBackend.counter;
                    });

                    // Opcjonalnie: wczytanie początkowej wartości
                    document.querySelector('.counter').innerText = window.cppBackend.counter;

                    //--------------------------------------------
                    //BUTTONS
                    //--------------------------------------------
                    document.getElementById('btn-start').addEventListener('click', function () {
                        window.cppBackend.start();
                    });

                    document.getElementById('btn-stop').addEventListener('click', function () {
                        window.cppBackend.stop();
                    });

                    document.getElementById('btn-reset').addEventListener('click', function () {
                        window.cppBackend.reset();
                    });

                    document.getElementById('btn-lap').addEventListener('click', function () {
                        window.cppBackend.addLap();
                    })


                    //--------------------------------------------
                    // FORM: Set time
                    //--------------------------------------------
                    // document.getElementById('form-set-time').addEventListener('submit', function (event) {
                    //     // 1. Zatrzymujemy domyślne przeładowanie strony po kliknięciu wyślij/Enter
                    //     event.preventDefault();

                    //     // 2. Pobieramy tekst z pola input
                    //     var timeText = document.getElementById('input-time').value;

                    //     // 3. Wywołujemy C++ i odbieramy bool w callbacku (jako funkcja na końcu)
                    //     window.cppBackend.setResetTimeSec(timeText, function (returnValue) {
                    //         // 4. Wypisujemy to co zwróciło C++ (true/false) na konsolę
                    //         console.log("Wynik parsowania w C++: " + returnValue);

                    //         // 5. Opcjonalnie: jeśli się udało (true), to czyścimy pole tekstowe
                    //         if (returnValue === true) {
                    //             document.getElementById('input-time').value = '';
                    //             console.log("Ustawiono nowy czas!");
                    //         } else {
                    //             console.error("Błąd! C++ nie potrafiło sparsować wpisanego czasu.");
                    //         }
                    //     });
                    // });

                    // //jQuery implementation
                     $('#form-set-time').submit(function (event) {

                        // 1. Zatrzymujemy domyślne przeładowanie strony po kliknięciu wyślij/Enter
                        event.preventDefault();

                        // 2. Pobieramy tekst z pola input (w jQuery używamy .val())
                        var timeText = $('#input-time').val();

                        // 3. Wywołujemy C++ i odbieramy bool w callbacku (to zostaje bez zmian)
                        window.cppBackend.setResetTimeSec(timeText, function (returnValue) {
                            
                            // 4. Wypisujemy to co zwróciło C++ (true/false) na konsolę
                            console.log("Wynik parsowania w C++: " + returnValue);

                            // 5. Jeśli się udało (true), to czyścimy pole tekstowe (w jQuery przekazujemy pusty string do .val(''))
                            if (returnValue === true) {
                                $('#input-time').val('');
                                console.log("Ustawiono nowy czas!");
                                $('#laplist').append("Ustawiono nowy czas!" + '<br>');
                            } else {
                                console.error("Błąd! C++ nie potrafiło sparsować wpisanego czasu.");
                                $('#laplist').append("Błąd! C++ nie potrafiło sparsować wpisanego czasu." + '<br>');
                            }
                        });
                     });

                });
            }

        }

    </script>

</head>

<body>

    <div class='mobile-view'>
        <div class='top-half'>
            <h1 style='align-self: center'>Hello from html!</h1>
            <h1 class='counter'>0</h1>
        </div>

        <div class='bottom-half'>
            <button id="btn-start" class='normal-button'>Start</button>
            <button id="btn-stop" class='normal-button'>Stop</button>
            <button id="btn-reset" class='normal-button'>Reset</button>
            <button id="btn-lap" class='normal-button'>Lap</button>

            <!-- NOWY FORMULARZ -->
            <hr style="margin: 15px 0;">
            <form id="form-set-time" style="text-align: center;">
                <input class='normal-input' type="text" id="input-time" placeholder="Enter time...">
                <br>
                <button type="submit" class='normal-button'>Set time</button>
            </form>
            <hr style="margin: 15px 0;">


            <p>Dolna połowa ekranu</p>

            <div data-options="region:'east',split:true" title="Laps" id="laplist" style="width:100px;">
            </div>

            <hr>

        </div>

    </div>

</body>

</html>