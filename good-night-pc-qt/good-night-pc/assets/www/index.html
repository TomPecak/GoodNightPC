<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Moja Aplikacja</title>

    <link rel="stylesheet" href="styles.css" />
    <script type="text/javascript" src="qwebchannel.js"></script>

    <script>
        'use strict';
        var wsUri = "ws://localhost:12345";
        window.loggedin = false;

        window.onload = function () {
            var socket = new WebSocket(wsUri);

            socket.onclose = function () {
                console.error("web channel closed");
            };

            socket.onerror = function (error) {
                console.error("web channel error: " + error);
            };


            socket.onopen = function () {
                console.log("WebSocket połączony!");

                // To jest kluczowe! Tworzymy kanał i przekazujemy mu nasz socket.
                window.channel = new QWebChannel(socket, function (channel) {
                    // Pobieramy obiekt 'backend' (tę nazwę zarejestrowałeś w main.cpp)
                    window.cppBackend = channel.objects.backend;

                    //----------------------------------------------------
                    //---------- CPP BACKEND -----------------------------
                    //----------------------------------------------------

                    //---------- CPP BACKEND LAP SIGNAL ------------------
                    window.cppBackend.lapListChanged.connect(function () {

                        if (window.cppBackend.lapList.length > 0) {
                            document.getElementById('list-container').hidden = false;
                        } else {
                            document.getElementById('list-container').hidden = true;
                            return;
                        }

                        const listDiv = document.getElementById('laplist');
                        listDiv.textContent = ''; // czyści szybciej niż innerHTML

                        const fragment = document.createDocumentFragment();

                        window.cppBackend.lapList.forEach(function (lap) {
                            const div = document.createElement('div');
                            div.textContent = lap;
                            fragment.appendChild(div);
                        });

                        listDiv.appendChild(fragment);
                    });

                    //---------- CPP BACKEND COUNTER SIGNAL ---------------
                    window.cppBackend.counterChanged.connect(function () {
                        console.log("Licznik zmieniony! Nowa wartość: " + window.cppBackend.counter);
                        // Aktualizacja HTML:
                        document.getElementById('input-time').value = window.cppBackend.counter;
                    });

                    //--------- CPP BACKEND PERCENT CALLBACK --------------
                    window.cppBackend.percentChanged.connect(function () {
                        document.documentElement.style.setProperty('--circle-progress-percent', window.cppBackend.percent);
                    });

                    //------------ CPP BACKEND INIT VALUES -------------------------------------
                    document.getElementById('input-time').value = window.cppBackend.counter;
                    document.documentElement.style.setProperty('--circle-progress-percent', window.cppBackend.percent);



                    //-------------------------------------------------------
                    //-------------- FRONTEND CALLBACKS ---------------------
                    //-------------------------------------------------------

                    document.getElementById('btn-start').addEventListener('click', function () {
                        window.cppBackend.start();
                    });

                    document.getElementById('btn-stop').addEventListener('click', function () {
                        window.cppBackend.stop();
                    });

                    document.getElementById('btn-reset').addEventListener('click', function () {
                        window.cppBackend.reset();
                        //document.getElementById('input-time').value = window.cppBackend.counter;
                    });

                    document.getElementById('btn-lap').addEventListener('click', function () {
                        window.cppBackend.addLap();
                    })

                    document.getElementById('input-time').addEventListener('input', function (event) {
                        //zdarzenia zmian edycji inputa na bierzaco (realtime)
                    });

                    document.getElementById('input-time').addEventListener('change', function (event) {
                        //zdarzenie po zakonczeniu edycji

                        var timeText = event.target.value;

                        window.cppBackend.setResetTimeSec(timeText, function (returnValue) {

                            // 4. Wypisujemy to co zwróciło C++ (true/false) na konsolę
                            console.log("Wynik parsowania w C++: " + returnValue);

                            // 5. Jeśli się udało (true), to czyścimy pole tekstowe (w jQuery przekazujemy pusty string do .val(''))
                            if (returnValue === true) {
                                console.log("Ustawiono nowy czas!");
                                document.getElementById('laplist').innerHTML += "Ustawiono nowy czas!<br>";
                            } else {
                                console.error("Błąd! C++ nie potrafiło sparsować wpisanego czasu.");
                                document.getElementById('laplist').innerHTML += "Błąd! C++ nie potrafiło sparsować wpisanego czasu.<br>";
                            }
                        });
                    });
                });
            }
        }
    </script>

</head>

<body>

    <div class='mobile-view'>
        <div class='top-half'>
            <!--            <h1 style='align-self: center'>Hello from html!</h1>-->
            <h1 class='counter' hidden>0</h1>

            <div class="skill">
                <div class="outer">
                    <div class="inner">


                        <form id="form-set-time" style="text-align: center;">
                            <input class='normal-input' type="number" min="0" step="1" id="input-time">
                            <!-- <br>
                <button type="submit" class='normal-button'>Set time</button> -->
                        </form>


                    </div>
                </div>

                <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="160px" height="160px">
                    <defs>
                        <linearGradient id="GradientColor">
                            <stop offset="0%" stop-color="#DA22FF" />
                            <stop offset="100%" stop-color="#9733EE" />
                        </linearGradient>
                    </defs>
                    <circle cx="80" cy="80" r="70" stroke-linecap="round" pathLength="100" />
                </svg>

            </div>

        </div>

        <div class='bottom-half'>

            <div class='button-row'>
                <button id="btn-lap" class='normal-button circle-button'>
                    <span class="material-symbols-outlined">add</span>
                </button>
                <button id="btn-start" class='normal-button'>Start</button>
                <button id="btn-stop" class='normal-button'>Stop</button>
                <button id="btn-reset" class='normal-button circle-button'>
                    <span class="material-symbols-outlined">restart_alt</span>
                </button>

            </div>


            <hr hidden style="margin: 15px 0;">


            <div hidden id="list-container">
                <p style="margin-top: 25px; margin-left: 25px;">Laps list from C++:</p>
                <div data-options="region:'east',split:true" title="Laps" id="laplist"
                    style="width:100px;margin-left: 50px;">
                </div>
            </div>


            <hr hidden>

        </div>

    </div>

</body>

</html>